<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>商品关系深度分析系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            min-height: 100vh;
            padding: 20px;
            color: #ecf0f1;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.8rem;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 12px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.2rem;
            color: #bdc3c7;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.7;
        }

        .dashboard {
            display: flex;
            gap: 25px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 25px;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .main-chart {
            flex: 3;
            height: 650px;
        }

        .detail-chart {
            flex: 2;
            height: 650px;
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 1.4rem;
            color: #3498db;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
        }

        .btn {
            padding: 10px 22px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.5);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #2c3e50, #34495e);
        }

        .btn.secondary:hover {
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.5);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 42, 108, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
            transition: opacity 0.4s;
        }

        .spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(52, 152, 219, 0.3);
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin-bottom: 30px;
        }

        .loading-text {
            font-size: 1.6rem;
            color: #ecf0f1;
            font-weight: 500;
            text-align: center;
            margin-bottom: 20px;
        }

        .loading-subtext {
            color: #bdc3c7;
            max-width: 500px;
            text-align: center;
            line-height: 1.6;
        }

        .progress-bar {
            width: 400px;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 30px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.6s ease;
            border-radius: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard {
            animation: fadeIn 0.8s ease-out;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            color: #7f8c8d;
            font-size: 1rem;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 30px;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 50%;
        }
        
        .node-label {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* 新增的关联深度面板样式 */
        .relation-depth-panel {
            flex: 1;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            padding: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .depth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .depth-title {
            font-size: 1.2rem;
            color: #3498db;
            font-weight: 600;
        }
        
        .depth-controls {
            display: flex;
            gap: 10px;
        }
        
        .depth-btn {
            padding: 6px 12px;
            border-radius: 6px;
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .depth-btn:hover {
            background: rgba(52, 152, 219, 0.4);
        }
        
        .depth-table {
            flex: 1;
            overflow-y: auto;
        }
        
        .depth-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .depth-table th {
            background: rgba(52, 152, 219, 0.2);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: #3498db;
        }
        
        .depth-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .depth-table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .depth-table tr:hover {
            background: rgba(52, 152, 219, 0.15);
        }
        
        .rank-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3498db;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .rank-1 .rank-badge { background: #f1c40f; }
        .rank-2 .rank-badge { background: #95a5a6; }
        .rank-3 .rank-badge { background: #e67e22; }
        
        .relation-count {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 20px;
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .depth-table .asin-title {
            display: flex;
            align-items: center;
        }
        
        .thumbnail-small {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            margin-right: 10px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-project-diagram"></i> 商品关系深度分析系统</h1>
        <p>可视化展示商品间的关联关系，气泡大小表示关联强度，帮助您发现市场机会和商品组合策略</p>
    </div>

    <div class="dashboard">
        <div class="chart-container main-chart">
            <div class="chart-title">
                <span><i class="fas fa-network-wired"></i> 商品关系气泡网络图</span>
                <div class="controls">
                    <button class="btn" id="reset-btn">
                        <i class="fas fa-sync"></i> 重置视图
                    </button>
                    <button class="btn secondary" id="layout-btn">
                        <i class="fas fa-sitemap"></i> 优化布局
                    </button>
                </div>
            </div>
            <div id="main-network" style="width: 100%; height: 550px;"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>核心商品节点</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2ecc71;"></div>
                    <span>高度关联商品</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>边缘商品节点</span>
                </div>
            </div>
        </div>

        <div class="chart-container detail-chart">
            <div class="chart-title">
                <span><i class="fas fa-sitemap"></i> 商品关联树</span>
                <div class="controls">
                    <button class="btn secondary" id="expand-btn">
                        <i class="fas fa-expand"></i> 全部展开
                    </button>
                </div>
            </div>
            <div id="detail-tree" style="width: 100%; height: 300px;"></div>
            
            <!-- 新增的关联深度面板 -->
            <div class="relation-depth-panel">
                <div class="depth-header">
                    <div class="depth-title"><i class="fas fa-sort-amount-down"></i> 关联深度排序</div>
                    <div class="depth-controls">
                        <button class="depth-btn" id="sort-by-count">
                            <i class="fas fa-sort-numeric-down-alt"></i> 按关联数
                        </button>
                        <button class="depth-btn" id="sort-by-depth">
                            <i class="fas fa-layer-group"></i> 按深度
                        </button>
                    </div>
                </div>
                <div class="depth-table">
                    <table id="depth-table">
                        <thead>
                            <tr>
                                <th width="50">排名</th>
                                <th>商品</th>
                                <th width="100">关联数量</th>
                                <th width="100">关联深度</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 数据将通过JS动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>商品关系深度分析系统 © 2023 | 数据每24小时自动更新</p>
    </div>

    <div class="loading-overlay" id="loader">
        <div class="spinner"></div>
        <div class="loading-text">正在加载商品关系数据...</div>
        <div class="loading-subtext">系统正在解析商品关联关系，并准备可视化展示</div>
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
    </div>

<script>
    let mainChart = null;
    let detailChart = null;
    let globalData = null;
    let selectedNode = null;
    let linkCounts = {};
    let nodeDepths = {};

    // ✅ 初始化函数
    (async function init() {
        try {
            // 模拟进度条
            simulateProgress();
            
            // 创建图表实例
            mainChart = echarts.init(document.getElementById('main-network'));
            detailChart = echarts.init(document.getElementById('detail-tree'));
            
            // 加载商品数据
            globalData = await loadData('data/product_relations.json');
            
            // 计算节点连接数和深度
            calculateNodeMetrics();
            
            // 渲染图表
            renderMainChart();
            
            // 渲染关联深度排序表
            renderDepthTable();
            
            // 默认选中第一个节点
            if (globalData.nodes.length > 0) {
                selectedNode = globalData.nodes[0];
                renderDetailTree(selectedNode);
            }
            
            // 添加事件监听
            document.getElementById('reset-btn').addEventListener('click', resetView);
            document.getElementById('expand-btn').addEventListener('click', expandTree);
            document.getElementById('layout-btn').addEventListener('click', optimizeLayout);
            document.getElementById('sort-by-count').addEventListener('click', () => renderDepthTable('count'));
            document.getElementById('sort-by-depth').addEventListener('click', () => renderDepthTable('depth'));
            
            // 添加窗口自适应
            window.addEventListener('resize', () => {
                mainChart.resize();
                detailChart.resize();
            });
            
        } catch (error) {
            console.error('初始化失败:', error);
            document.querySelector('.loading-text').textContent = `初始化失败: ${error.message}`;
            document.querySelector('.loading-subtext').textContent = '请检查数据文件路径或网络连接';
            setTimeout(hideLoader, 5000);
        }
    })();

    // ✅ 模拟进度条
    function simulateProgress() {
        const progress = document.getElementById('progress');
        let width = 0;
        const interval = setInterval(() => {
            if (width >= 95) {
                clearInterval(interval);
                return;
            }
            width += 2;
            progress.style.width = `${width}%`;
        }, 80);
    }

    // ✅ 加载数据
    async function loadData(url) {
        try {
            // 使用相对路径加载数据
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`数据加载失败: HTTP ${response.status}`);
            }
            const data = await response.json();
            
            // 验证数据结构
            if (!data.nodes || !data.links) {
                throw new Error('无效的数据格式: 缺少nodes或links属性');
            }
            
            return data;
        } catch (error) {
            // 如果加载失败，使用示例数据
            console.error('加载数据失败，使用示例数据:', error);
            return getFallbackData();
        }
    }

    // ✅ 计算节点指标
    function calculateNodeMetrics() {
        // 重置指标
        linkCounts = {};
        nodeDepths = {};
        
        // 初始化
        globalData.nodes.forEach(node => {
            linkCounts[node.id] = 0;
            nodeDepths[node.id] = 0;
        });
        
        // 计算连接数
        globalData.links.forEach(link => {
            linkCounts[link.source]++;
            linkCounts[link.target]++;
        });
        
        // 计算节点深度（使用BFS）
        const nodeMap = new Map(globalData.nodes.map(n => [n.id, n]));
        
        globalData.nodes.forEach(node => {
            const visited = new Set();
            const queue = [{node: node, depth: 0}];
            let maxDepth = 0;
            
            while (queue.length > 0) {
                const {node, depth} = queue.shift();
                maxDepth = Math.max(maxDepth, depth);
                
                // 获取所有关联节点
                const neighbors = [
                    ...globalData.links.filter(l => l.source === node.id).map(l => l.target),
                    ...globalData.links.filter(l => l.target === node.id).map(l => l.source)
                ];
                
                neighbors.forEach(neighborId => {
                    if (!visited.has(neighborId)) {
                        visited.add(neighborId);
                        const neighbor = nodeMap.get(neighborId);
                        if (neighbor) {
                            queue.push({node: neighbor, depth: depth + 1});
                        }
                    }
                });
            }
            
            nodeDepths[node.id] = maxDepth;
        });
    }

    // ✅ 获取回退数据
    function getFallbackData() {
        return {
            "nodes": [
                {
                    "id": "B066595945",
                    "title": "JBL Flip 5 便携式蓝牙音箱",
                    "缩略图": "https://via.placeholder.com/150/3498db/FFFFFF?text=JBL+Speaker"
                },
                {
                    "id": "B019606483",
                    "title": "Sony WH-1000XM4 无线降噪耳机",
                    "缩略图": "https://via.placeholder.com/150/2ecc71/FFFFFF?text=Sony+Headphones"
                },
                {
                    "id": "B081138277",
                    "title": "Apple AirPods Pro",
                    "缩略图": "https://via.placeholder.com/150/e74c3c/FFFFFF?text=AirPods+Pro"
                },
                {
                    "id": "B002793567",
                    "title": "Bose SoundLink 蓝牙音箱",
                    "缩略图": "https://via.placeholder.com/150/9b59b6/FFFFFF?text=Bose+Speaker"
                },
                {
                    "id": "B07XJ8Y5K9",
                    "title": "Samsung Galaxy Buds Pro",
                    "缩略图": "https://via.placeholder.com/150/1abc9c/FFFFFF?text=Galaxy+Buds"
                },
                {
                    "id": "B08C4Y6HXK",
                    "title": "Anker Soundcore 蓝牙音箱",
                    "缩略图": "https://via.placeholder.com/150/f1c40f/FFFFFF?text=Soundcore"
                },
                {
                    "id": "B08H7Y9ZQY",
                    "title": "Jabra Elite 85t 无线耳机",
                    "缩略图": "https://via.placeholder.com/150/e67e22/FFFFFF?text=Jabra+Elite"
                },
                {
                    "id": "B07W6ZQYH6",
                    "title": "Beats Solo Pro 无线耳机",
                    "缩略图": "https://via.placeholder.com/150/34495e/FFFFFF?text=Beats+Solo"
                }
            ],
            "links": [
                {"source": "B066595945", "target": "B002793567"},
                {"source": "B066595945", "target": "B08C4Y6HXK"},
                {"source": "B019606483", "target": "B081138277"},
                {"source": "B019606483", "target": "B08H7Y9ZQY"},
                {"source": "B019606483", "target": "B07W6ZQYH6"},
                {"source": "B081138277", "target": "B07XJ8Y5K9"},
                {"source": "B081138277", "target": "B019606483"},
                {"source": "B002793567", "target": "B066595945"},
                {"source": "B002793567", "target": "B08C4Y6HXK"},
                {"source": "B07XJ8Y5K9", "target": "B081138277"},
                {"source": "B08C4Y6HXK", "target": "B066595945"},
                {"source": "B08H7Y9ZQY", "target": "B019606483"},
                {"source": "B07W6ZQYH6", "target": "B019606483"},
                {"source": "B07XJ8Y5K9", "target": "B08H7Y9ZQY"},
                {"source": "B07XJ8Y5K9", "target": "B07W6ZQYH6"},
                {"source": "B08C4Y6HXK", "target": "B08H7Y9ZQY"}
            ]
        };
    }

    // ✅ 隐藏加载界面
    function hideLoader() {
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
        }, 400);
    }

    // ✅ 重置视图
    function resetView() {
        if (globalData.nodes.length > 0) {
            selectedNode = globalData.nodes[0];
            renderDetailTree(selectedNode);
            mainChart.dispatchAction({ type: 'downplay' });
            mainChart.dispatchAction({
                type: 'highlight',
                seriesIndex: 0,
                dataIndex: [0]
            });
        }
    }

    // ✅ 优化布局
    function optimizeLayout() {
        mainChart.dispatchAction({
            type: 'forceLayout',
            animation: {
                duration: 1000,
                easing: 'cubicOut'
            }
        });
    }

    // ✅ 展开树状图
    function expandTree() {
        if (selectedNode) {
            renderDetailTree(selectedNode, true);
        }
    }

    // ✅ 渲染关联深度排序表
    function renderDepthTable(sortBy = 'count') {
        // 创建节点数据副本
        const nodes = [...globalData.nodes];
        
        // 排序逻辑
        if (sortBy === 'count') {
            nodes.sort((a, b) => linkCounts[b.id] - linkCounts[a.id]);
        } else {
            nodes.sort((a, b) => nodeDepths[b.id] - nodeDepths[a.id]);
        }
        
        // 获取表格容器
        const tbody = document.querySelector('#depth-table tbody');
        tbody.innerHTML = '';
        
        // 添加行
        nodes.slice(0, 20).forEach((node, index) => {
            const row = document.createElement('tr');
            if (index < 3) {
                row.classList.add(`rank-${index + 1}`);
            }
            
            row.innerHTML = `
                <td>
                    <span class="rank-badge">${index + 1}</span>
                </td>
                <td>
                    <div class="asin-title">
                        <img src="${node.缩略图}" class="thumbnail-small">
                        <div>
                            <div>${node.title.substring(0, 30)}${node.title.length > 30 ? '...' : ''}</div>
                            <div style="font-size: 0.85rem; color: #95a5a6; margin-top: 4px;">ASIN: ${node.id}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="relation-count">${linkCounts[node.id]}</span>
                </td>
                <td>
                    <span class="relation-count">${nodeDepths[node.id]}</span>
                </td>
            `;
            
            // 添加点击事件
            row.addEventListener('click', () => {
                selectedNode = node;
                renderDetailTree(node);
                highlightRelatedNodes(node.id);
                
                // 高亮网络图中的节点
                const nodeIndex = globalData.nodes.findIndex(n => n.id === node.id);
                mainChart.dispatchAction({
                    type: 'highlight',
                    seriesIndex: 0,
                    dataIndex: [nodeIndex]
                });
            });
            
            tbody.appendChild(row);
        });
    }

    // ✅ 主关系图配置（气泡版）
    function renderMainChart() {
        // 计算节点连接数
        const maxLinks = Math.max(...Object.values(linkCounts));
        const minLinks = Math.min(...Object.values(linkCounts));
        
        const option = {
            tooltip: {
                trigger: 'item',
                formatter: tooltipFormatter,
                backgroundColor: 'rgba(10, 15, 30, 0.95)',
                borderColor: '#3498db',
                borderWidth: 1,
                textStyle: {
                    color: '#ecf0f1'
                },
                padding: 0,
                extraCssText: 'box-shadow: 0 0 25px rgba(52, 152, 219, 0.5);'
            },
            series: [{
                type: 'graph',
                layout: 'force',
                force: {
                    repulsion: 300,
                    edgeLength: 150,
                    gravity: 0.1,
                    friction: 0.2
                },
                data: globalData.nodes.map(node => {
                    const links = linkCounts[node.id] || 0;
                    // 计算气泡大小（基于连接数）
                    const size = 20 + (links / maxLinks) * 80;
                    
                    // 根据连接数设置颜色
                    let color;
                    if (links > maxLinks * 0.7) color = '#3498db';
                    else if (links > maxLinks * 0.4) color = '#2ecc71';
                    else color = '#e74c3c';
                    
                    // 计算节点重要度（0-1）
                    const importance = (links - minLinks) / (maxLinks - minLinks);
                    
                    return {
                        ...node,
                        value: links, // 存储连接数
                        symbolSize: size,
                        symbol: 'circle',
                        itemStyle: {
                            color: {
                                type: 'radial',
                                x: 0.5,
                                y: 0.5,
                                r: 0.5,
                                colorStops: [
                                    {
                                        offset: 0,
                                        color: color
                                    },
                                    {
                                        offset: 1,
                                        color: 'rgba(0,0,0,0.2)'
                                    }
                                ],
                                global: false
                            },
                            borderColor: '#fff',
                            borderWidth: 2,
                            shadowColor: 'rgba(0, 0, 0, 0.5)',
                            shadowBlur: 10
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            fontSize: Math.max(10, 10 + importance * 8),
                            fontWeight: 'bold',
                            color: '#fff',
                            formatter: function(params) {
                                const words = params.data.title.split(' ');
                                return words.map(word => word.charAt(0)).join('');
                            }
                        },
                        emphasis: {
                            itemStyle: {
                                borderWidth: 4,
                                shadowBlur: 20,
                                shadowColor: 'rgba(52, 152, 219, 0.8)'
                            }
                        }
                    };
                }),
                links: globalData.links.map(link => ({
                    ...link,
                    lineStyle: {
                        color: 'rgba(127, 140, 141, 0.6)',
                        width: 1.5,
                        curveness: 0.2
                    }
                })),
                lineStyle: {
                    opacity: 0.8
                },
                emphasis: {
                    focus: 'adjacency',
                    lineStyle: {
                        width: 3,
                        color: '#3498db'
                    }
                },
                roam: true,
                draggable: true,
                animation: true,
                animationDuration: 1500,
                animationEasing: 'cubicOut'
            }]
        };
        
        mainChart.setOption(option);
        hideLoader();

        // 绑定点击事件
        mainChart.on('click', ({ data }) => {
            if (data) {
                selectedNode = data;
                renderDetailTree(data);
                highlightRelatedNodes(data.id);
            }
        });
        
        // 初始高亮第一个节点
        if (globalData.nodes.length > 0) {
            setTimeout(() => {
                mainChart.dispatchAction({
                    type: 'highlight',
                    seriesIndex: 0,
                    dataIndex: [0]
                });
            }, 500);
        }
    }

    // ✅ 生成详情树状图
    function renderDetailTree(selectedNode, expandAll = false) {
        const treeData = buildHierarchy(selectedNode, 3); // 3层深度

        const option = {
            tooltip: {
                formatter: tooltipFormatter,
                position: ['50%', '50%'],
                padding: 0,
                backgroundColor: 'rgba(10, 15, 30, 0.95)',
                borderColor: '#3498db',
                extraCssText: 'box-shadow: 0 0 25px rgba(52, 152, 219, 0.5);'
            },
            series: [{
                type: 'tree',
                data: [treeData],
                orient: 'vertical',
                initialTreeDepth: expandAll ? -1 : 1,
                expandAndCollapse: true,
                edgeShape: 'polyline',
                edgeForkPosition: '50%',
                label: {
                    position: 'left',
                    verticalAlign: 'middle',
                    align: 'right',
                    fontSize: 13,
                    color: '#ecf0f1',
                    backgroundColor: 'rgba(0, 0, 0, 0.6)',
                    padding: [4, 8],
                    borderRadius: 4,
                    formatter: ({ data }) => data.name.split(' ').slice(0, 3).join(' ')
                },
                leaves: {
                    label: {
                        position: 'right',
                        color: '#bdc3c7'
                    }
                },
                lineStyle: {
                    color: 'rgba(127, 140, 141, 0.6)',
                    width: 1.5,
                    curveness: 0.25
                },
                itemStyle: {
                    color: '#3498db',
                    borderColor: '#fff'
                },
                symbol: `image://${selectedNode.缩略图}`,
                symbolSize: [40, 40],
                animationDuration: 800
            }]
        };
        
        detailChart.setOption(option, true);
        
        // 更新标题
        document.querySelector('.detail-chart .chart-title span').textContent = 
            `${selectedNode.title.split(' ').slice(0, 3).join(' ')} 关联树`;
    }

    // ✅ 构建层级关系树
    function buildHierarchy(rootNode, maxDepth) {
        const nodeMap = new Map(globalData.nodes.map(n => [n.id, n]));
        const visited = new Set();

        function buildTree(currentNode, depth = 0) {
            if (depth >= maxDepth || visited.has(currentNode.id)) return null;
            visited.add(currentNode.id);

            const children = globalData.links
                .filter(link => link.source === currentNode.id)
                .map(link => {
                    const child = nodeMap.get(link.target);
                    return child ? buildTree(child, depth + 1) : null;
                })
                .filter(Boolean);

            return {
                name: currentNode.title,
                value: currentNode,
                children: children.length ? children : null,
                symbol: `image://${currentNode.缩略图}`,
                symbolSize: [30, 30],
                itemStyle: {
                    color: '#3498db'
                }
            };
        }

        return buildTree(rootNode);
    }

    // ✅ 高亮关联节点
    function highlightRelatedNodes(asin) {
        const relatedNodes = globalData.links
            .filter(link => link.source === asin || link.target === asin)
            .flatMap(link => [link.source, link.target])
            .filter(id => id !== asin);

        mainChart.dispatchAction({
            type: 'highlight',
            seriesIndex: 0,
            dataIndex: relatedNodes.map(id => 
                globalData.nodes.findIndex(n => n.id === id)
            )
        });
    }

    // ✅ 工具提示格式化
    function tooltipFormatter(params) {
        const data = params.data.value || params.data;
        return `
            <div style="
                padding: 20px;
                background: linear-gradient(135deg, #1a2a6c, #2c3e50);
                border-radius: 10px;
                min-width: 280px;
                border: 1px solid #3498db;
            ">
                <div style="text-align: center; margin-bottom: 15px;">
                    <img src="${data.缩略图}" 
                         style="width: 150px; height: 150px; border-radius: 8px; object-fit: cover; border: 2px solid #3498db;">
                </div>
                <div style="
                    font-size: 18px;
                    color: #ecf0f1;
                    margin-bottom: 10px;
                    font-weight: 600;
                    text-align: center;
                ">${data.title}</div>
                <div style="
                    background: rgba(52, 152, 219, 0.2);
                    padding: 10px;
                    border-radius: 8px;
                    text-align: center;
                    margin-top: 15px;
                ">
                    <div style="font-size: 16px; color: #3498db; font-weight: 600;">ASIN: ${data.id}</div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                    <div style="text-align: center; flex: 1;">
                        <div style="font-size: 14px; color: #bdc3c7;">关联数量</div>
                        <div style="font-size: 24px; color: #2ecc71; font-weight: 700;">${linkCounts[data.id] || 0}</div>
                    </div>
                    <div style="text-align: center; flex: 1;">
                        <div style="font-size: 14px; color: #bdc3c7;">关联深度</div>
                        <div style="font-size: 24px; color: #f1c40f; font-weight: 700;">${nodeDepths[data.id] || 0}</div>
                    </div>
                </div>
            </div>
        `;
    }
</script>
</body>
</html>
